<style>
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
    }
    body {
        height: 100vh;
        min-height: 100vh;
        background: #f7f9fb;
    }
    .app-root-flex {
        display: flex;
        width: 100vw;
        min-height: 100vh;
        background: #f7f9fb;
    }
    .sidebar-modern {
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        width: 220px;
        max-width: 240px;
        min-width: 180px;
        background: linear-gradient(120deg, #e4edfb 60%, #f4f7fa 100%);
        box-shadow: 2px 0 16px -7px #739ccd20;
        border-right: 1.5px solid #e6eaf4;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: stretch;
        padding: 2.4rem 0 2rem 0;
        z-index: 3;
        transition: all 0.33s cubic-bezier(.46,0,.13,1);
    }
    .sidebar-brand {
        color: #3667ad;
        font-weight: bold;
        font-size: 1.24em;
        letter-spacing: 0.03em;
        padding: 0 2.2rem 2.5rem 2.2rem;
        user-select: none;
        display: flex;
        align-items: center;
        gap: 0.6em;
    }
    .sidebar-nav {
        flex: 1 1 auto;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        padding: 0 0.7rem 0 0.7rem;
    }
    .sidebar-nav-link {
        display: flex;
        align-items: center;
        gap: 0.88em;
        font-size: 1.1em;
        font-weight: 500;
        background: transparent;
        border: none;
        color: #254874;
        padding: 0.94em 1.1em 0.94em 1.3em;
        border-radius: 0.66em;
        cursor: pointer;
        margin-bottom: 0.23em;
        transition: background 0.14s, color 0.16s, box-shadow 0.12s;
        text-align: left;
        outline: none;
        box-shadow: 0 1.5px 10px 0 #b8c9ed15;
        position: relative;
        text-decoration: none;
    }
    .sidebar-nav-link.active, .sidebar-nav-link:focus, .sidebar-nav-link:hover {
        background: linear-gradient(90deg,#eaf3ff 70%,#e0f7fa 100%);
        color: #3667ad;
        box-shadow: 0 1.5px 12px #c4def612;
    }
    .sidebar-nav-link .sidebar-emoji {
        font-size: 1.16em;
        margin-right: 0.3em;
    }
    .main-content {
        margin-left: 220px;
        padding: 0;
        flex: 1 1 0;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: stretch;
        background: #f8fafc;
        height: 100vh;
        box-sizing: border-box;
    }
    .agent-config-form {
        flex: 1 1 auto;
        display: flex;
        flex-direction: column;
        gap: 2.1em;
        width: 100%;
        max-width: 100vw;
        margin: 0;
        background: #fff;
        border-radius: 1.2em;
        box-shadow: 0 2px 22px #719de81a;
        padding: 2.7rem 2.5rem 2.2rem 2.5rem;
        min-height: 0;
        min-width: 0;
        box-sizing: border-box;
        /* Make sure relative for absolute buttons (fix) */
        position: relative;
    }
    .field-group {
        display: flex;
        flex-direction: column;
        gap: 0.34em;
        /* --- Fix: inherit form background for versioning field-groups --- */
        background: inherit;
    }
    /* --- Ensure all versioning groups also get form-style background if inserted at root --- */
    .agent-config-form > .field-group,
    .agent-config-form > .field-group.tools-select-group,
    .agent-config-form > .field-group.instruction-group {
        background: inherit !important;
    }
    .field-label {
        font-size: 1.13em;
        color: #2c4e80;
        font-weight: 600;
        margin-bottom: 0.31em;
        letter-spacing: 0.01em;
    }
    .field-select, .field-input, .field-textarea {
        font-size: 1.08em;
        padding: 0.76em 1.1em;
        border: 1.5px solid #bdd9f7;
        border-radius: 0.75em;
        background: #f7fcff;
        color: #234c7b;
        outline: none;
        transition: border-color 0.15s;
        font-family: inherit;
        margin-bottom: 0;
        min-width: 0;
    }
    .field-select:focus, .field-input:focus, .field-textarea:focus {
        border-color: #3667ad;
        background: #f3f7fb;
    }
    .field-textarea {
        min-height: 190px;
        resize: vertical;
        font-size: 1.08em;
        font-family: inherit;
        line-height: 1.45;
    }
    .tools-select-group {
        display: flex;
        flex-direction: column;
        gap: 0.5em;
        margin-top: 0.23em;
        background: inherit;
    }
    .selected-tools-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5em;
        margin-top: 0.5em;
        min-height: 2.1em;
        background: inherit;
    }
    .tool-chip {
        display: flex;
        align-items: center;
        background: linear-gradient(93deg,#eaf3ff 70%,#e0f7fa 100%);
        color: #3667ad;
        border: 1.2px solid #bdd9f7;
        border-radius: 2em;
        padding: 0.25em 0.86em 0.25em 0.9em;
        font-size: 1.00em;
        font-weight: 500;
        margin: 0 0.04em;
        box-shadow: 0 1px 6px #b6e8fc16;
        position: relative;
        background-clip: padding-box;
    }
    .tool-chip .remove-tool-btn {
        color: #3667ad;
        background: none;
        border: none;
        padding: 0.1em 0.52em 0.1em 0.23em;
        cursor: pointer;
        font-size: 1.05em;
        font-weight: bold;
        outline: none;
        margin-left: 0.3em;
        border-radius: 1em;
        transition: background 0.15s;
    }
    .tool-chip .remove-tool-btn:hover,
    .tool-chip .remove-tool-btn:focus {
        background: #e4ecfa;
        color: #21528f;
    }
    .config-btn-group,
    .config-btn-group.versioning-action-group {
        display: flex;
        gap: 1em;
        flex-direction: row;
        justify-content: flex-end;
        align-items: center;
        margin-top: 1.5em;
        margin-bottom: 0.2em;
        /* match background, border, and box-shadow to the form */
        background: #fff;
        border-radius: 1.2em;
        box-shadow: 0 2px 22px #719de81a;
        border: none;
        padding: 1.1em 0 0.75em 0;
        /* Ensure on top if necessary */
        position: relative;
        z-index: 1;
    }
    .config-btn {
        padding: 0.7em 2em;
        border-radius: 0.8em;
        border: none;
        outline: none;
        font-size: 1.1em;
        font-weight: 600;
        background: linear-gradient(95deg,#eaf3ff 70%,#e0f7fa 100%);
        color: #3667ad;
        box-shadow: 0 1.5px 10px 0 #c3e8fa18;
        cursor: pointer;
        letter-spacing: 0.01em;
        transition: background 0.18s, color 0.14s, box-shadow 0.17s, transform 0.17s;
        border: 1.5px solid #bdd9f7;
        /* Fix - make button backgrounds more solid on top of form's white */
        /* Place on white by default to avoid inconsistent backgrounds */
        position: relative;
    }
    .config-btn:hover, .config-btn:focus {
        background: linear-gradient(92deg,#e4edfb 60%, #e0f7fa 100%);
        color: #21528f;
        box-shadow: 0 2.5px 16px #b7e0fd24;
        transform: translateY(-1px) scale(1.01);
    }
    .config-btn.apply {
        background: linear-gradient(90deg,#cbefff 70%,#bfdafc 100%);
        color: #2467ac;
        border-color: #add8fb;
    }
    .config-btn.apply:hover, .config-btn.apply:focus {
        background: linear-gradient(88deg,#afd7fa 60%,#c1f1ff 100%);
        color: #234c7b;
        box-shadow: 0 3px 18px #aee5ff22;
    }
    .config-btn.cancel {
        background: linear-gradient(93deg,#f8fafb 60%,#eaf3ff 100%);
        color: #2c4e80;
        border-color: #bdd9f7;
    }
    .config-btn.cancel:hover, .config-btn.cancel:focus {
        background: linear-gradient(94deg,#eaf3ff 80%,#f7f9fb 100%);
        color: #254874;
    }
    .config-btn.create {
        background: linear-gradient(90deg,#cbefff 70%,#bfdafc 100%);
        color: #2467ac;
        border-color: #add8fb;
    }
    .config-btn.create:hover, .config-btn.create:focus {
        background: linear-gradient(88deg,#afd7fa 60%,#c1f1ff 100%);
        color: #234c7b;
        box-shadow: 0 3px 18px #aee5ff22;
    }
    /*--- ADDED new field group for instruction textarea ---*/
    .field-group.instruction-group {
        margin-top: 0.6em;
        margin-bottom: 0;
        background: inherit !important;
    }
    @media (max-width: 940px) {
        .main-content {
            margin-left: 0;
            width: 100vw;
            padding: 0.9em;
        }
        .agent-config-form {
            padding: 1.4rem 0.8rem 1.3rem 0.8rem;
            margin-top: 0;
            min-width: 0;
            min-height: 0;
            max-width: 100vw;
        }
        .config-btn-group,
        .config-btn-group.versioning-action-group {
            flex-direction: column;
            gap: 0.7em;
            align-items: stretch;
            border-radius: 1.2em 1.2em 1.2em 1.2em;
            box-shadow: 0 2px 22px #719de81a;
        }
    }
</style>

<div class="app-root-flex">
    <nav class="sidebar-modern" id="app-sidebar">
        <div class="sidebar-brand">
            <span style="font-size:1.45em;filter:drop-shadow(0 2px 8px #94bdf854);">ü§ñ</span>
            <span>Assistant Suite</span>
        </div>
        <div class="sidebar-nav">
            <a href="#" class="sidebar-nav-link" data-section="tests">
                <span class="sidebar-emoji">üß™</span>
                Tests
            </a>
            <a href="#" class="sidebar-nav-link active" data-section="agent">
                <span class="sidebar-emoji">‚öôÔ∏è</span>
                Agent Configuration
            </a>
            <a href="#" class="sidebar-nav-link" data-section="chat">
                <span class="sidebar-emoji">üí¨</span>
                Live Chat
            </a>
        </div>
    </nav>
    <main class="main-content">
        <form class="agent-config-form" autocomplete="off" onsubmit="event.preventDefault();">
            <div class="field-group">
                <label for="agent-type" class="field-label">Agent Type</label>
                <select id="agent-type" class="field-select">
                    <option value="React">React</option>
                    <option value="Tool Calling">Tool Calling</option>
                </select>
            </div>
            <div class="field-group" id="model-group">
                <label for="model" class="field-label">Model</label>
                <select id="model" class="field-select">
                    <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
                    <option value="gpt-4">gpt-4</option>
                </select>
            </div>
            <div class="field-group" id="count-group">
                <label for="count-input" class="field-label">Count</label>
                <input type="number" id="count-input" class="field-input" value="10" min="1" step="1">
            </div>
            <div class="field-group" id="system-prompt-group">
                <label for="system-prompt" class="field-label">System Prompt</label>
                <textarea id="system-prompt" class="field-textarea" placeholder="Enter system prompt here..."></textarea>
            </div>
            <div class="field-group tools-select-group" id="tools-select-group">
                <label for="tools-combo" class="field-label">Tools</label>
                <select id="tools-combo" class="field-select">
                    <option value="" selected disabled>Select a tool...</option>
                    <option value="tavily search">Tavily Search</option>
                    <option value="calculate">Calculate</option>
                </select>
                <div class="selected-tools-list" id="selected-tools-list">
                    <!-- Selected tools will appear here -->
                </div>
            </div>
            <!-- ADDED: Instruction textarea for response generator ‚Äî shown only for Tool Calling -->
            <div class="field-group instruction-group" id="instruction-response-generator-group" style="display: none;">
                <label for="instruction-response-generator" class="field-label">Instruction for response generator</label>
                <textarea id="instruction-response-generator" class="field-textarea" placeholder="Enter instruction for response generator..."></textarea>
            </div>
            <!-- Modern button group added here -->
            <div class="config-btn-group" id="main-action-group">
                <button type="button" class="config-btn" id="btn-versioning" onclick="OnVersionningClicked()">Versioning</button>
                <button type="button" class="config-btn apply" id="btn-apply" onclick="OnApplyClicked()">Apply</button>
            </div>
        </form>
    </main>
</div>
<script>
    // Sidebar section logging (unchanged)
    function logSidebarSectionName(node) {
        let text = "";
        node.childNodes.forEach(child => {
            if (child.nodeType === Node.TEXT_NODE && child.textContent.trim() !== '') {
                text += child.textContent.trim();
            }
        });
        if (!text) {
            text = node.textContent.trim();
        }
        if (text == "Tests") {
            window.location.href = "/tests";
        } else if (text == "Live Chat") {
            window.location.href = "/chat"
        }
    }

    // Minimal version of helpers for versioning (unchanged)
    function cloneFieldGroup({labelText, labelFor, inputElem}) {
        const group = document.createElement("div");
        group.className = "field-group";
        // --- Ensure background is always inherited from parent form, solves bug ---
        group.style.background = "inherit";
        const label = document.createElement("label");
        label.className = "field-label";
        label.setAttribute("for", labelFor);
        label.textContent = labelText;
        group.appendChild(label);
        group.appendChild(inputElem);
        return group;
    }

    function cloneSelect(originalId, newId) {
        const orig = document.getElementById(originalId);
        const clone = orig.cloneNode(true);
        clone.id = newId;
        return clone;
    }

    function cloneTextarea(originalId, newId, placeholder = "") {
        const orig = document.getElementById(originalId);
        const clone = orig.cloneNode(true);
        clone.id = newId;
        clone.value = "";
        if (placeholder) clone.placeholder = placeholder;
        return clone;
    }

    function cloneCountInput(originalId, newId) {
        // Always create a new <input type="number" ...>
        const orig = document.getElementById(originalId);
        const input = document.createElement("input");
        input.type = "number";
        input.className = "field-input";
        input.id = newId;
        input.value = "10";
        input.min = "1";
        input.step = "1";
        return input;
    }

    function cloneToolsFieldGroup() {
        const group = document.createElement("div");
        group.className = "field-group tools-select-group";
        // --- Ensure background is always inherited, solves bug ---
        group.style.background = "inherit";
        // Label
        const label = document.createElement("label");
        label.className = "field-label";
        label.setAttribute("for", "new-tools-combo");
        label.textContent = "New Tools";
        // Select
        const select = document.createElement("select");
        select.className = "field-select";
        select.id = "new-tools-combo";
        select.innerHTML = `
            <option value="" selected disabled>Select a tool...</option>
            <option value="tavily search">Tavily Search</option>
            <option value="calculate">Calculate</option>
        `;
        // Chips list
        const selectedList = document.createElement("div");
        selectedList.className = "selected-tools-list";
        selectedList.id = "new-selected-tools-list";
        // --- Ensure background is inherited for selected tools list ---
        selectedList.style.background = "inherit";
        group.appendChild(label); group.appendChild(select); group.appendChild(selectedList);

        // Custom (VERSIONING) Instruction textarea for response generator
        const instructionGroup = document.createElement("div");
        instructionGroup.className = "field-group instruction-group";
        instructionGroup.id = "new-instruction-response-generator-group";
        instructionGroup.style.display = "none";
        // Ensures new version instruction field is visually within the form's background
        instructionGroup.style.background = "inherit";
        const instructionLabel = document.createElement("label");
        instructionLabel.className = "field-label";
        instructionLabel.setAttribute("for", "new-instruction-response-generator");
        instructionLabel.textContent = "Instruction for response generator";
        const instructionTextarea = document.createElement("textarea");
        instructionTextarea.id = "new-instruction-response-generator";
        instructionTextarea.className = "field-textarea";
        instructionTextarea.placeholder = "Enter instruction for response generator...";
        instructionGroup.appendChild(instructionLabel);
        instructionGroup.appendChild(instructionTextarea);
        group.appendChild(instructionGroup);

        return group;
    }

    // Button event methods (modified for count input)
    function OnVersionningClicked() {
        const mainActionGroup = document.getElementById("main-action-group");
        if (mainActionGroup) mainActionGroup.remove();
        const form = document.querySelector('.agent-config-form');
        // New fields
        const newAgentTypeGroup = cloneFieldGroup({
            labelText: "New Agent Type",
            labelFor: "new-agent-type",
            inputElem: (() => {
                const select = cloneSelect("agent-type", "new-agent-type");
                return select;
            })()
        });

        // Re-ordered: Add New Model THEN New Count
        const newModelGroup = cloneFieldGroup({
            labelText: "New Model",
            labelFor: "new-model",
            inputElem: (() => {
                const select = cloneSelect("model", "new-model");
                return select;
            })()
        });

        const newCountGroup = cloneFieldGroup({
            labelText: "New Count",
            labelFor: "new-count-input",
            inputElem: (() => {
                const countInput = cloneCountInput("count-input", "new-count-input");
                return countInput;
            })()
        });

        const newPromptGroup = cloneFieldGroup({
            labelText: "New System Prompt",
            labelFor: "new-system-prompt",
            inputElem: (() => {
                const textarea = cloneTextarea("system-prompt", "new-system-prompt", "Enter new system prompt here...");
                return textarea;
            })()
        });
        const newToolsGroup = cloneToolsFieldGroup();

        // Fix: insert in a container DIV with background (to avoid any future bug)
        if (!form.querySelector('.versioning-fields-container')) {
            const container = document.createElement('div');
            container.className = 'versioning-fields-container';
            // Ensure same background as form
            container.style.background = "inherit";
            container.style.borderRadius = "inherit";
            container.style.display = "flex";
            container.style.flexDirection = "column";
            container.style.gap = "2.1em";
            container.style.padding = "0"; // no extra padding
            container.style.margin = "0";
            container.style.boxSizing = "border-box";
            // Add new fields to container
            container.appendChild(newAgentTypeGroup);
            container.appendChild(newModelGroup);
            container.appendChild(newCountGroup);
            container.appendChild(newPromptGroup);
            container.appendChild(newToolsGroup);
            // Insert container at the end of the form but before buttons
            form.appendChild(container);
        }

        // If new versioning fields already exist from a previous buggy state, remove them (defensive)
        Array.from(form.children).forEach(child => {
            if (
                child !== form.querySelector('.versioning-fields-container') &&
                (child === newAgentTypeGroup || child === newModelGroup || child === newCountGroup || child === newPromptGroup || child === newToolsGroup)
            ) {
                child.remove();
            }
        });

        // Versioning: show/hide additional instruction textarea under newToolsGroup
        const newAgentTypeSelect = newAgentTypeGroup.querySelector('select');
        const newInstructionGroup = newToolsGroup.querySelector("#new-instruction-response-generator-group");
        // ADDED: Hide newCountGroup for Tool Calling
        function toggleNewInstructionAndCountFields() {
            if (newAgentTypeSelect.value === "Tool Calling") {
                newInstructionGroup.style.display = "";
                newCountGroup.style.display = "none";
            } else {
                newInstructionGroup.style.display = "none";
                newCountGroup.style.display = "";
            }
        }
        // Initial state for versioning
        toggleNewInstructionAndCountFields();
        newAgentTypeSelect.addEventListener("change", toggleNewInstructionAndCountFields);

        const btnGroup = document.createElement("div");
        btnGroup.className = "config-btn-group versioning-action-group";
        btnGroup.id = "versioning-action-group";

        const cancelBtn = document.createElement("button");
        cancelBtn.type = "button";
        cancelBtn.className = "config-btn cancel";
        cancelBtn.textContent = "Cancel";
        cancelBtn.onclick = function() {
            const container = form.querySelector('.versioning-fields-container');
            if (container) container.remove();
            btnGroup.remove();
            restoreMainActionButtons();
        };

        const createBtn = document.createElement("button");
        createBtn.type = "button";
        createBtn.className = "config-btn create";
        createBtn.textContent = "Create New Version";
        createBtn.onclick = function() {
            // Same as before
            const oldAgentType = document.getElementById("agent-type").value;
            const oldCount = document.getElementById("count-input").value;
            const oldModel = document.getElementById("model").value;
            const oldPrompt = document.getElementById("system-prompt").value;
            // Gather current selected tools (for old)
            const oldSelectedTools = [];
            const selectedToolsList = document.getElementById("selected-tools-list");
            if (selectedToolsList) {
                const chips = selectedToolsList.querySelectorAll('.tool-chip');
                chips.forEach(function(chip) {
                    let textNodes = Array.from(chip.childNodes).filter(n => n.nodeType === Node.TEXT_NODE);
                    let name = textNodes.map(n => n.textContent.trim()).join(' ');
                    if (name) oldSelectedTools.push(name);
                });
            }
            // New values
            const newAgentType = document.getElementById("new-agent-type").value;
            const newCount = document.getElementById("new-count-input").value;
            const newModel = document.getElementById("new-model").value;
            const newPrompt = document.getElementById("new-system-prompt").value;
            // Gather new selected tools
            const newSelectedTools = [];
            const newSelectedToolsList = document.getElementById("new-selected-tools-list");
            if (newSelectedToolsList) {
                const chips = newSelectedToolsList.querySelectorAll('.tool-chip');
                chips.forEach(function(chip) {
                    let textNodes = Array.from(chip.childNodes).filter(n => n.nodeType === Node.TEXT_NODE);
                    let name = textNodes.map(n => n.textContent.trim()).join(' ');
                    if (name) newSelectedTools.push(name);
                });
            }
            // Get new instruction value (for Tool Calling)
            let newInstruction = '';
            const newInstructionElem = document.getElementById('new-instruction-response-generator');
            if (newInstructionElem && newInstructionElem.parentElement.style.display !== "none") {
                newInstruction = newInstructionElem.value;
            }
            function arraysEqual(arr1, arr2) {
                if (arr1.length !== arr2.length) return false;
                for (let i = 0; i < arr1.length; i++) {
                    if (arr1[i] !== arr2[i]) return false;
                }
                return true;
            }
            const allSame =
                oldAgentType === newAgentType &&
                oldCount === newCount &&
                oldModel === newModel &&
                oldPrompt === newPrompt &&
                arraysEqual(oldSelectedTools, newSelectedTools);
                // (Could compare instruction for completeness)

            if (allSame) {
                console.log("they're all the same");
            } else {
                console.log("there's a change!!");
            }
        };

        btnGroup.appendChild(cancelBtn);
        btnGroup.appendChild(createBtn);
        form.appendChild(btnGroup);
        // New tools select logic for versioning
        const newToolsCombo = document.getElementById("new-tools-combo");
        const newSelectedToolsList = document.getElementById("new-selected-tools-list");
        let newSelectedTools = [];
        function renderNewSelectedTools() {
            newSelectedToolsList.innerHTML = "";
            if (newSelectedTools.length === 0) {
                newSelectedToolsList.style.minHeight = "2.1em";
            }
            newSelectedTools.forEach(function(tool, idx) {
                const chip = document.createElement("div");
                chip.className = "tool-chip";
                chip.textContent = capitalize(tool);
                const removeBtn = document.createElement("button");
                removeBtn.className = "remove-tool-btn";
                removeBtn.type = "button";
                removeBtn.title = "Remove";
                removeBtn.innerHTML = "&times;";
                removeBtn.onclick = function() {
                    newSelectedTools.splice(idx, 1);
                    renderNewSelectedTools();
                };
                chip.appendChild(removeBtn);
                newSelectedToolsList.appendChild(chip);
            });
        }
        function capitalize(txt) {
            if (!txt) return '';
            if (txt.toLowerCase() === "tavily search") return "Tavily Search";
            if (txt.toLowerCase() === "calculate") return "Calculate";
            return txt.charAt(0).toUpperCase() + txt.slice(1);
        }
        newToolsCombo.addEventListener("change", function() {
            const value = newToolsCombo.value;
            if (value && !newSelectedTools.includes(value)) {
                newSelectedTools.push(value);
                renderNewSelectedTools();
            }
            newToolsCombo.selectedIndex = 0;
        });
        renderNewSelectedTools();
    }

    function restoreMainActionButtons() {
        const form = document.querySelector('.agent-config-form');
        // Remove container if present
        const container = form.querySelector('.versioning-fields-container');
        if (container) container.remove();

        const mainActionGroup = document.createElement("div");
        mainActionGroup.className = "config-btn-group";
        mainActionGroup.id = "main-action-group";
        const verBtn = document.createElement("button");
        verBtn.type = "button";
        verBtn.className = "config-btn";
        verBtn.id = "btn-versioning";
        verBtn.onclick = OnVersionningClicked;
        verBtn.textContent = "Versioning";
        const applyBtn = document.createElement("button");
        applyBtn.type = "button";
        applyBtn.className = "config-btn apply";
        applyBtn.id = "btn-apply";
        applyBtn.onclick = OnApplyClicked;
        applyBtn.textContent = "Apply";
        mainActionGroup.appendChild(verBtn);
        mainActionGroup.appendChild(applyBtn);
        form.appendChild(mainActionGroup);
    }

    function OnApplyClicked() {
        console.log("Apply");
    }

    // --- Dynamic Agent Type Form Behaviour for "React" and "Tool Calling" ---
    document.addEventListener("DOMContentLoaded", function() {
        var sidebarLinks = document.querySelectorAll('.sidebar-nav-link');
        sidebarLinks.forEach(function(link) {
            link.addEventListener('click', function(e) {
                logSidebarSectionName(this);
            });
        });

        // --- Agent Type dynamic rendering ---
        const agentTypeSelect = document.getElementById('agent-type');
        const modelGroup = document.getElementById('model-group');
        const systemPromptGroup = document.getElementById('system-prompt-group');
        const toolsSelectGroup = document.getElementById('tools-select-group');
        const countGroup = document.getElementById('count-group');
        const instructionGroup = document.getElementById('instruction-response-generator-group');

        function setFormFieldsForAgentType(type) {
            if (type === "React") {
                // Show all four: Model, Count, System Prompt, Tools
                modelGroup.style.display = "";
                countGroup.style.display = "";
                systemPromptGroup.style.display = "";
                toolsSelectGroup.style.display = "";
                if (instructionGroup) instructionGroup.style.display = "none";
            } else if (type === "Tool Calling") {
                modelGroup.style.display = "";
                countGroup.style.display = "none"; // HIDE count for Tool Calling
                systemPromptGroup.style.display = "";
                toolsSelectGroup.style.display = "";
                if (instructionGroup) instructionGroup.style.display = "";
            }
        }
        // Initialize
        setFormFieldsForAgentType(agentTypeSelect.value);
        agentTypeSelect.addEventListener('change', function() {
            setFormFieldsForAgentType(agentTypeSelect.value);
        });

        // ---- Agent Config Form logic (tools select) ----
        const toolsCombo = document.getElementById("tools-combo");
        const selectedToolsList = document.getElementById("selected-tools-list");
        let selectedTools = [];

        function renderSelectedTools() {
            selectedToolsList.innerHTML = "";
            if (selectedTools.length === 0) {
                selectedToolsList.style.minHeight = "2.1em";
            }
            selectedTools.forEach(function(tool, idx) {
                const chip = document.createElement("div");
                chip.className = "tool-chip";
                chip.textContent = capitalize(tool);

                const removeBtn = document.createElement("button");
                removeBtn.className = "remove-tool-btn";
                removeBtn.type = "button";
                removeBtn.title = "Remove";
                removeBtn.innerHTML = "&times;";
                removeBtn.onclick = function() {
                    selectedTools.splice(idx, 1);
                    renderSelectedTools();
                };
                chip.appendChild(removeBtn);
                selectedToolsList.appendChild(chip);
            });
        }

        function capitalize(txt) {
            if (!txt) return '';
            if (txt.toLowerCase() === "tavily search") return "Tavily Search";
            if (txt.toLowerCase() === "calculate") return "Calculate";
            return txt.charAt(0).toUpperCase() + txt.slice(1);
        }

        toolsCombo.addEventListener("change", function() {
            const value = toolsCombo.value;
            if (value && !selectedTools.includes(value)) {
                selectedTools.push(value);
                renderSelectedTools();
            }
            toolsCombo.selectedIndex = 0;
        });

        renderSelectedTools();
    });
</script>
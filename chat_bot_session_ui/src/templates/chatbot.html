<style>
    body {
        margin: 0;
        padding: 0;
        background: #f7f9fb;
    }
    .app-root-flex {
        display: flex;
        width: 100vw;
        min-height: 100vh;
        background: #f7f9fb;
    }
    .sidebar-modern {
        flex: 0 0 220px;
        max-width: 240px;
        min-width: 180px;
        background: linear-gradient(120deg, #e4edfb 60%, #f4f7fa 100%);
        box-shadow: 2px 0 16px -7px #739ccd20;
        border-right: 1.5px solid #e6eaf4;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: stretch;
        padding: 2.4rem 0 2rem 0;
        z-index: 3;
        transition: all 0.33s cubic-bezier(.46,0,.13,1);
    }
    .sidebar-brand {
        color: #3667ad;
        font-weight: bold;
        font-size: 1.24em;
        letter-spacing: 0.03em;
        padding: 0 2.2rem 2.5rem 2.2rem;
        user-select: none;
        display: flex;
        align-items: center;
        gap: 0.6em;
    }
    .sidebar-nav {
        flex: 1 1 auto;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        padding: 0 0.7rem 0 0.7rem;
    }
    .sidebar-nav-link {
        display: flex;
        align-items: center;
        gap: 0.88em;
        font-size: 1.1em;
        font-weight: 500;
        background: transparent;
        border: none;
        color: #254874;
        padding: 0.94em 1.1em 0.94em 1.3em;
        border-radius: 0.66em;
        cursor: pointer;
        margin-bottom: 0.23em;
        transition: background 0.14s, color 0.16s, box-shadow 0.12s;
        text-align: left;
        outline: none;
        box-shadow: 0 1.5px 10px 0 #b8c9ed15;
        position: relative;
        text-decoration: none;
    }
    .sidebar-nav-link.active, .sidebar-nav-link:focus, .sidebar-nav-link:hover {
        background: linear-gradient(90deg,#eaf3ff 70%,#e0f7fa 100%);
        color: #3667ad;
        box-shadow: 0 1.5px 12px #c4def612;
    }
    .sidebar-nav-link .sidebar-emoji {
        font-size: 1.16em;
        margin-right: 0.3em;
    }

    /* Chat Layout */
    .chatbot-main-section {
        flex: 1 1 0;
        display: flex;
        flex-direction: column;
        min-width: 0;
        background: linear-gradient(110deg, #f7fbff 80%, #eaf4fb 100%);
    }

    /* Action Bar Styles */
    .action-bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1.2em;
        font-size: 1.17em;
        color: #3360a4;
        font-weight: 700;
        letter-spacing: 0.01em;
        background: linear-gradient(90deg, #f1f7fc 75%, #e9f3fd 100%);
        padding: 0.72em 1.3em;
        border-bottom: 1.5px solid #e6effc;
        user-select: none;
        min-height: 2.1em;
        box-shadow: 0 4px 28px -18px #96bde80f;
    }
    .action-bar-title {
        display: flex;
        align-items: center;
        gap: 0.65em;
        font-size: 1.15em;
    }
    .action-bar-buttons {
        display: flex;
        align-items: center;
        gap: 0.45em;
    }
    .action-bar-btn {
        background: #f7fcff;
        border: 1.2px solid #bdd9f7;
        color: #376ab1;
        border-radius: 1.14em;
        padding: 0.46em 1.12em;
        font-size: 0.97em;
        font-weight: 500;
        margin: 0 0.05em;
        cursor: pointer;
        box-shadow: 0 1px 7px #b6e8fc22;
        transition: background 0.13s, border-color 0.14s, color 0.14s;
    }
    .action-bar-btn.active,
    .action-bar-btn:hover,
    .action-bar-btn:focus {
        background: linear-gradient(90deg,#eaf3ff 70%,#e0f7fa 100%);
        border-color: #4db4ef;
        color: #21528f;
        outline: none;
    }

    /* Typing Indicator Dots */
    .typing-indicator {
        display: inline-flex;
        align-items: center;
        height: 1.44em;
        margin-left: 0.42em;
        vertical-align: middle;
        /* place it near the emoji */
    }
    .typing-dot {
        display: inline-block;
        width: 0.53em;
        height: 0.53em;
        margin-right: 0.22em;
        border-radius: 50%;
        background: #a7bad4;
        opacity: 0.65;
        animation: typing-bounce 1.3s infinite cubic-bezier(.65,.05,.36,1);
    }
    .typing-dot:nth-child(2) {
        animation-delay: 0.16s;
    }
    .typing-dot:nth-child(3) {
        animation-delay: 0.32s;
    }
    @keyframes typing-bounce {
        0%   { transform: translateY(0);    opacity: 0.55; }
        20%  { transform: translateY(-0.33em); opacity: 1;}
        40%  { transform: translateY(0);    opacity: 0.7; }
        100% { transform: translateY(0);    opacity: 0.55;}
    }

    @media (max-width: 940px) {
        .action-bar, .chatbot-footer {
            padding-left: 1em;
            padding-right: 1em;
        }
        .chat-window, .chat-message-row {
            padding-left: 0.7em;
            padding-right: 0.7em;
        }
    }
    @media (max-width: 600px) {
        .action-bar, .chatbot-footer {
            padding-left: 0.2em;
            padding-right: 0.2em;
            font-size: 1em;
        }
        .chat-window, .chat-message-row {
            padding-left: 0.1em;
            padding-right: 0.1em;
        }
        .chat-message-bubble {
            font-size: 1em;
            padding: 0.8em 1em;
            white-space: pre-wrap;
        }
        .chatbot-input {
            font-size: 1em;
            padding: 0.7em 1em;
        }
        .chatbot-send-btn {
            font-size: 1em;
            padding: 0.7em 1em;
        }
        .action-bar {
            padding-top: 0.45em;
            padding-bottom: 0.45em;
            min-height: 1.4em;
        }
    }
    .chat-window {
        flex: 1 1 0;
        padding: 1.5em 0 0.7em 0;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 1.35em;
        background: none;
    }
    .chat-message-row {
        display: flex;
        align-items: flex-end;
        justify-content: flex-start;
        padding: 0 2.1em;
    }
    .chat-message-bubble {
        display: block;
        width: 100%;
        padding: 1em 1.25em;
        border-radius: 1.1em 1.1em 1.15em 1.15em;
        font-size: 1.09em;
        max-width: 100%;
        box-shadow: 0 2px 10px #bfdffa28;
        margin-bottom: 0.16em;
        margin-left: 0;
        margin-right: 0;
        /* Make message fill the width like ChatGPT/Claude */
    }
    .chat-message.user .chat-message-bubble {
        background: linear-gradient(90deg,#e6f2ff 65%,#e0fcfd 100%);
        color: #244a7a;
        border-top-right-radius: 0.35em;
        border: 1px solid #c2d9fa;
        margin-left: 0;
    }
    .chat-message.bot .chat-message-bubble {
        background: linear-gradient(90deg,#e4f5ec 80%,#cdf1fa 100%);
        color: #247a57;
        border-top-left-radius: 0.35em;
        border: 1px solid #bce6db;
        margin-right: 0;
    }
    .chat-message-emoji {
        font-size: 1.33em;
        margin-right: 0.43em;
        vertical-align: middle;
        filter: drop-shadow(0 0.07em 2px #ffffff80);
    }
    /* --- Tool Cart Stylish Component --- */
    .tool-cart-container {
        margin: 1.1em 0 0.2em 0;
        padding: 1.1em 1.3em 1.1em 1.2em;
        background: linear-gradient(90deg,#eef9fb 80%, #e0edfc 100%);
        border: 1.6px solid #b5deff;
        border-radius: 1em;
        box-shadow: 0 2px 11px #9cdbfa17;
        font-size: 1em;
        color: #255a82;
        display: flex;
        flex-direction: column;
        gap: 0.6em;
        max-width: 99%;
        /* Responsive for side scroll: */
        overflow-x: auto;
        margin-left: 2.1em;
        margin-right: 0;
    }
    .tool-cart-title {
        display: flex;
        align-items: center;
        font-weight: bold;
        font-size: 1.05em;
        color: #247a57;
        margin-bottom: 0.25em;
        gap: 0.5em;
    }
    .tool-cart-badge {
        display: inline-block;
        background: linear-gradient(90deg, #88e2e9 60%, #f0faff 100%);
        border-radius: 0.66em;
        padding: 0.22em 0.9em;
        font-size: 0.93em;
        margin-left: 0.6em;
        color: #225b64;
        font-weight: 700;
        letter-spacing: 0.015em;
        box-shadow: 0 1px 5px #51dbe540;
    }
    .tool-cart-table {
        width: 100%;
        border-collapse: collapse;
        background: none;
        margin-top: 0.13em;
    }
    .tool-cart-table th,
    .tool-cart-table td {
        padding: 0.28em 0.58em;
        text-align: left;
        vertical-align: top;
        background: none;
        border: none;
        font-size: 0.98em;
    }
    .tool-cart-table th {
        color: #216689;
        font-weight: 700;
        background: none;
        width: 28%;
        letter-spacing: 0.01em;
    }
    .tool-cart-table td {
        color: #234881;
        font-weight: 500;
        background: none;
        max-width: 37vw;
        word-break: break-all;
    }
    .tool-cart-divider {
        height: 1.5px;
        background: linear-gradient(90deg,#b7e2fa 60%,#e2f7f7 100%);
        border: 0;
        margin: 0.42em 0 0.55em 0;
        border-radius: 1em;
    }

    .chatbot-footer {
        padding: 1.35em 2em 1.7em 2em;
        background: none;
        border-top: 1px solid #e9effc;
        display: flex;
        align-items: flex-end;
        gap: 1em;
    }
    .chatbot-input-box {
        flex: 1 1 0;
        display: flex;
        position: relative;
    }
    /* Change: allow textarea to expand for multi-line, styled as before */
    .chatbot-input {
        width: 100%;
        padding: 1em 1.2em 1em 1.2em;
        font-size: 1.12em;
        border-radius: 1.6em;
        border: 1.2px solid #b6d2f7;
        background: #f9fbff;
        color: #284b71;
        outline: none;
        box-shadow: 0 2px 10px #b6e8fc11;
        transition: border-color 0.19s, box-shadow 0.18s;
        resize: none;
        min-height: 2.5em;
        max-height: 9em;
        line-height: 1.45;
        overflow-y: hidden; /* CHANGED: Hide vertical scrollbar */
        /* Ensure wrapping for long lines */
        white-space: pre-wrap;
        word-break: break-word;
    }
    .chatbot-input:focus {
        border-color: #66a9ee;
        box-shadow: 0 2px 14px #b4dffc28;
        background: #f2faff;
    }
    .chatbot-send-btn {
        margin-left: 0.65em;
        padding: 0.86em 1.36em;
        border-radius: 1.4em;
        background: linear-gradient(90deg,#53bbff 70%,#7efce5 100%);
        color: #fff;
        font-weight: 600;
        font-size: 1.08em;
        border: none;
        cursor: pointer;
        box-shadow: 0 2px 12px #b6e6fa39;
        transition: background 0.16s, opacity 0.18s;
        opacity: 0.95;
        height: auto;
        /* Keep Send button from stretching with textarea */
        align-self: flex-end;
        flex-shrink: 0;
    }
    .chatbot-send-btn:active {
        opacity: 0.8;
        background: linear-gradient(90deg,#409fd7 68%,#4aeed0 100%);
    }
    /* Code Editor section */
    #code-section {
        display: none;
        flex: 1 1 0;
        min-height: 0;
        min-width: 0;
        background: #f7f9fb; /* Set to match chatbot panel's bg-light */
        position: relative;
    }
    #monaco-editor-container {
        width: 100%;
        height: 100%;
        min-height: 280px;
        background: #f7f9fb;
        border-radius: 0.8em;
        box-shadow: 0 3px 18px #b7c7e944;
        border: 1.5px solid #e7eaf2;
    }

    /* -------- Logger Page Styles -------- */
    #logger-section {
        display: none;
        flex: 1 1 0;
        min-height: 0;
        min-width: 0;
        background: #f7f9fb;
        flex-direction: column;
        padding: 1em 0 1em 0; /* reduced vertical padding */
        gap: 0.85em;          /* smaller, uniform spacing between log blocks */
        overflow-y: auto;
        align-items: stretch;  /* keep this so log-blocks stretch */
    }

    .log-block {
        width: 100%;
        max-width: none;
        margin: 0 0 0 0; /* remove bottom margin; use parent gap for spacing */
        box-shadow: 0 2px 14px #d0e7ff1c;
        border-radius: 1em;
        overflow: hidden;
        font-size: 1.07em;
        transition: box-shadow 0.16s;
    }
    /* Collapsible Info */
    .log-collapsed-info {
        background: linear-gradient(90deg,#eaf3ff 65%,#e3eefb 100%);
        border: 1.7px solid #b9dafc;
        color: #254874;
        box-shadow: 0 2px 14px #bcdfff1c;
        padding: 0;
        position: relative;
    }
    .log-collapsed-header {
        cursor: pointer;
        font-weight: 600;
        font-size: 1.06em;
        padding: 0.75em 1.3em;      /* reduced padding for header */
        display: flex;
        align-items: center;
        gap: 1em;
        border-bottom: 1px solid #e1eaf6;
        user-select: none;
        background: none;
        color: #21528f;
        transition: background 0.13s;
    }
    .log-collapsed-header:hover {
        background: #f3fafe;
    }
    .log-arrow {
        display: inline-block;
        font-size: 1.18em;
        margin-right: 0.6em;
        transition: transform 0.19s;
    }
    .log-collapsed-body {
        padding: 0.72em 1.3em 0.86em 1.3em;   /* reduced body padding for compact spacing */
        color: #305173;
        line-height: 1.7;
        background: none;
    }
    .log-collapsed-info.collapsed .log-collapsed-body {
        display: none;
    }
    .log-collapsed-info.collapsed .log-arrow {
        transform: rotate(-90deg);
    }

    /* Simple Info */
    .log-info {
        background: #fff;
        color: #275082;
        border: 1.5px solid #deebfa;
        box-shadow: 0 2px 16px #c6dffe13;
        padding: 0.72em 1.3em;    /* reduced to match header/body of collapsed info */
        font-weight: 500;
        border-radius: 1em;
        line-height: 1.7;
        position: relative;
    }

    /* Warning */
    .log-warning {
        background: linear-gradient(90deg,#fffbe7 70%,#fcf6ca 100%);
        color: #83660a;
        border: 1.5px solid #fae6bb;
        box-shadow: 0 4px 18px -4px #ffe9a759;
        padding: 0.72em 1.3em;    /* reduced and uniform */
        font-weight: 500;
        border-radius: 1em;
        line-height: 1.7;
        position: relative;
        display: flex;
        align-items: flex-start;
        gap: 0.77em;
    }
    .log-warning-icon {
        font-size: 1.35em;
        margin-right: 0.4em;
        margin-top: 0.06em;
        flex-shrink: 0;
        color: #cf7f09;
        text-shadow: 0 0.1em 8px #ffe13b25;
    }

    /* Error */
    .log-error {
        background: linear-gradient(90deg,#ffebee 70%, #ffd5d580 100%);
        color: #c92828;
        border: 1.7px solid #ffbec6;
        box-shadow: 0 4px 24px -4px #ec838316;
        padding: 0.72em 1.3em;   /* reduced and uniform */
        font-weight: 600;
        border-radius: 1em;
        line-height: 1.7;
        position: relative;
        display: flex;
        align-items: flex-start;
        gap: 0.8em;
    }
    .log-error-icon {
        font-size: 1.36em;
        margin-right: 0.42em;
        margin-top: 0.04em;
        flex-shrink: 0;
        color: #e32d3c;
        text-shadow: 0 0.1em 9px #dda6bd40;
    }
</style>

<script id="data-json" type="application/json">
        {{ data | tojson }}
</script>

<!-- Monaco loader (from CDN) -->

<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.min.js"></script>

<div class="app-root-flex">
    <aside class="sidebar-modern" id="app-sidebar">
        <div class="sidebar-brand" id="sidebar-brand">
            <span style="font-size:1.35em;">ü§ñ</span>
        </div>
        <nav class="sidebar-nav">
            <a href="#" class="sidebar-nav-link" data-section="chat">
                <span class="sidebar-emoji">üß™</span>
                Tests
            </a>
            <a href="#" class="sidebar-nav-link" data-section="history">
                <span class="sidebar-emoji">‚öôÔ∏è</span>
                Agent Configuration
            </a>
            <a href="#" class="sidebar-nav-link active" data-section="settings">
                <span class="sidebar-emoji">üí¨</span>
                Live Chat
            </a>
        </nav>
    </aside>
    <main class="chatbot-main-section">
        <div class="action-bar">
            <div class="action-bar-title">
                <span class="chat-message-emoji">üí¨</span>
                <span>AI Assistant</span>
            </div>
            <div class="action-bar-buttons">
                <button class="action-bar-btn active" id="btn-chat" type="button">Chat</button>
                <button class="action-bar-btn" id="btn-code" type="button">Code</button>
                <button class="action-bar-btn" type="button" id="btn-logger">Logge</button>
            </div>
        </div>
        <!-- Toggleable: Chat view, Code Editor, Logger view -->
        <section class="chat-window" id="chat-window">
            <!-- <div class="chat-message-row chat-message bot">
                <div class="chat-message-bubble">
                    <span class="chat-message-emoji">ü§ñ</span>Hi! How can I help you today?
                </div>
            </div> -->
        </section>
        <section id="code-section">
            <div id="monaco-editor-container"></div>
        </section>
        <section id="logger-section">
            <!-- Collapsible info -->
            <div class="log-block log-collapsed-info" id="log-collapsed-info-1">
                <div class="log-collapsed-header" tabindex="0">
                    <span class="log-arrow">&#9654;</span>
                    Collapsible Information
                </div>
                <div class="log-collapsed-body">
                    This section can be collapsed. It gives detailed information, for example helpful expanded logs or explanations.
                    <br><br>
                    When collapsed, only the title is visible.
                    <br>
                    <em>You can define your own logic/text here. This component fits a modern assistant UI.</em>
                </div>
            </div>
            <!-- Info message -->
            <div class="log-block log-info">
                This is an informational message with a white background. Use this component to show neutral logs or information to the user.
            </div>
            <!-- Warning message -->
            <div class="log-block log-warning">
                <span class="log-warning-icon">‚ö†Ô∏è</span>
                <span>
                    <strong>Warning:</strong> This action might have unintended consequences. Please double-check your configuration and proceed carefully.
                </span>
            </div>
            <!-- Error message -->
            <div class="log-block log-error">
                <span class="log-error-icon">‚õî</span>
                <span>
                    <strong>Error:</strong> Something went wrong and your request could not be processed.<br>
                    Please try again or contact support if the problem persists.
                </span>
            </div>
        </section>
        <footer class="chatbot-footer" id="chatbot-footer">
            <form id="chatbot-form" style="display: flex; flex:1; gap: 1em;">
                <div class="chatbot-input-box">
                    <textarea
                        class="chatbot-input"
                        id="chatbot-input"
                        placeholder="Type your message and hit Enter..."
                        autocomplete="off"
                        required
                        rows="1"
                    ></textarea>
                </div>
                <button type="submit" class="chatbot-send-btn" id="chatbot-send-btn">
                    Send
                </button>
            </form>
        </footer>
    </main>
</div>

<script>
(function() {

    var data ; 
    window.addEventListener("DOMContentLoaded", () => {
            data = JSON.parse(document.getElementById("data-json").textContent);
            console.log(data)
            let assistant_div = document.getElementById("sidebar-brand") ; 
            const assistant_name = document.createTextNode(data["agent_name"]) ; 
            assistant_div.appendChild(assistant_name) ; 
            if (data["agent_type"] != "code_act") {
                document.getElementById("btn-code").style.display = "none";
            }
        });
    function escapeHtml(str) {
        return str.replace(/[&<>"']/g, function(match) {
            switch (match) {
                case "&": return "&amp;";
                case "<": return "&lt;";
                case ">": return "&gt;";
                case '"': return "&quot;";
                case "'": return "&#039;";
            }
        });
    }

    const chatWindow = document.getElementById('chat-window');
    const chatForm = document.getElementById('chatbot-form');
    const chatInput = document.getElementById('chatbot-input');
    const sendBtn = document.getElementById('chatbot-send-btn');
    const chatFooter = document.getElementById('chatbot-footer');
    const codeSection = document.getElementById('code-section');
    const loggerSection = document.getElementById('logger-section');
    let monacoEditor = null;
    let monacoInitialized = false;
    let monacoLoaderQueue = [];
    let chatBusy = false; // Added: flag to track if chat is busy

    function appendMessage(text, sender = "user") {
        const row = document.createElement('div');
        row.className = 'chat-message-row chat-message ' + sender;

        const bubble = document.createElement('div');
        bubble.className = 'chat-message-bubble';

        let emoji = sender === "bot" ? 'ü§ñ' : 'üßë';
        bubble.innerHTML = `<span class="chat-message-emoji">${emoji}</span>${escapeHtml(text)}`;
        row.appendChild(bubble);
        chatWindow.appendChild(row);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    // Typing indicator management
    let typingIndicatorRow = null;
    let typingIndicatorBubble = null;

    function showTypingIndicator() {
        if(typingIndicatorRow) return;

        typingIndicatorRow = document.createElement('div');
        typingIndicatorRow.className = 'chat-message-row chat-message bot';
        typingIndicatorBubble = document.createElement('div');
        typingIndicatorBubble.className = 'chat-message-bubble';

        let emoji = "ü§ñ";
        typingIndicatorBubble.innerHTML =
            `<span class="chat-message-emoji">${emoji}</span>
            <span class="typing-indicator">
                <span class="typing-dot"></span>
                <span class="typing-dot"></span>
                <span class="typing-dot"></span>
            </span>`;

        typingIndicatorRow.appendChild(typingIndicatorBubble);
        chatWindow.appendChild(typingIndicatorRow);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }
    function hideTypingIndicator() {
        if (typingIndicatorRow && typingIndicatorRow.parentNode) {
            typingIndicatorRow.parentNode.removeChild(typingIndicatorRow);
        }
        typingIndicatorRow = null;
        typingIndicatorBubble = null;
    }


    // This version no longer calls appendStream directly:
    function appendStream(){
        // This function is called when fetch starts (and should REMOVE typing indicator)
        hideTypingIndicator();
        const row = document.createElement('div');
        row.className = 'chat-message-row chat-message ' + "bot";

        const bubble = document.createElement('div');
        bubble.className = 'chat-message-bubble';

        let emoji =  'ü§ñ' 
        bubble.innerHTML = `<span class="chat-message-emoji">${emoji}</span>`;
        row.appendChild(bubble);
        chatWindow.appendChild(row);
        chatWindow.scrollTop = chatWindow.scrollHeight;
        return bubble 
    }

    function parseActionString(actionStr) {
        const nameMatch = actionStr.match(/<name>\s*([\s\S]*?)\s*<\/name>/);
        const name = nameMatch ? nameMatch[1].trim() : null;

      const inputsMatch = actionStr.match(/<inputs>\s*([\s\S]*?)\s*<\/inputs>/);
       let inputs = {};
        if (inputsMatch) {
        try {
        inputs = JSON.parse(inputsMatch[1].trim());
        } catch (e) {
        console.error("Invalid JSON in inputs:", e);
        }
    }

    return { name, inputs };
    }

    function createToolCart(actionDict) {
        // Helper: make a tool "cart" node
        const cart = document.createElement('div');
        cart.className = "tool-cart-container";

        // Title row with cart icon, tool name badge
        const title = document.createElement('div');
        title.className = "tool-cart-title";
        title.innerHTML = `Tool <span class="tool-cart-badge">${escapeHtml(actionDict.name || 'Unknown')}</span>`;
        cart.appendChild(title);

        // Divider under title
        const divider = document.createElement('div');
        divider.className = "tool-cart-divider";
        cart.appendChild(divider);

        // Inputs table
        const table = document.createElement('table');
        table.className = "tool-cart-table";
        const thead = document.createElement('thead');
        const tbody = document.createElement('tbody');

        let foundInputs = false;
        if (actionDict.inputs && typeof actionDict.inputs === "object" && Object.keys(actionDict.inputs).length > 0) {
            foundInputs = true;
            Object.keys(actionDict.inputs).forEach(k => {
                const tr = document.createElement('tr');
                const th = document.createElement('th');
                th.textContent = k;
                const td = document.createElement('td');
                let val = actionDict.inputs[k];
                td.textContent = typeof val === "object" ? JSON.stringify(val) : String(val);
                tr.appendChild(th); tr.appendChild(td);
                tbody.appendChild(tr);
            });
        }

        if (foundInputs) {
            table.appendChild(tbody);
        } else {
            // No inputs, add a row stating "No inputs"
            const tr = document.createElement('tr');
            const td = document.createElement('td');
            td.textContent = "No tool inputs provided.";
            td.colSpan = 2;
            td.style.color = "#7186a4";
            tr.appendChild(td);
            tbody.appendChild(tr);
            table.appendChild(tbody);
        }

        cart.appendChild(table);

        // Horizontal divider WITH button group overlaid in the center
        const dividerWithButton = document.createElement('div');
        dividerWithButton.style.position = "relative";
        dividerWithButton.style.marginTop = "1.7em";
        dividerWithButton.style.marginBottom = "0.1em";
        dividerWithButton.style.height = "2.6em"; // Height enough for buttons

        // The line
        const hrLine = document.createElement('div');
        hrLine.style.position = "absolute";
        hrLine.style.top = "50%";
        hrLine.style.left = "0";
        hrLine.style.right = "0";
        hrLine.style.height = "2px";
        hrLine.style.background = "linear-gradient(90deg, #e1e8f0 90%, #e8ecee 100%)";
        hrLine.style.transform = "translateY(-50%)";
        dividerWithButton.appendChild(hrLine);

        // Button group container (to center absolutely)
        const btnRow = document.createElement('div');
        btnRow.style.position = "absolute";
        btnRow.style.left = "50%";
        btnRow.style.top = "50%";
        btnRow.style.transform = "translate(-50%, -50%)";
        btnRow.style.display = "flex";
        btnRow.style.justifyContent = "center";
        btnRow.style.alignItems = "center";
        btnRow.style.gap = "0.8em";
        // Remove marginTop because it's now centered over the line

        // Validate button
        const validateBtn = document.createElement('button');
        validateBtn.type = "button";
        validateBtn.innerHTML = "<span style='font-size:1.14em;margin-right:0.46em;'>‚úîÔ∏è</span>Validate";
        validateBtn.style.background = "linear-gradient(90deg, #c1e5c1 80%, #ecf8ea 100%)";
        validateBtn.style.color = "#257631";
        validateBtn.style.fontWeight = "600";
        validateBtn.style.padding = "0.58em 1.45em";
        validateBtn.style.border = "none";
        validateBtn.style.borderRadius = "0.9em";
        validateBtn.style.fontSize = "1em";
        validateBtn.style.cursor = "pointer";
        validateBtn.style.boxShadow = "0 2px 9px #badcbd31";
        validateBtn.style.transition = "background 0.13s, color 0.13s, box-shadow 0.14s";
        validateBtn.onmouseover = function() {
            validateBtn.style.background = "linear-gradient(90deg,#b4f6b4 70%,#e0fce7 100%)";
            validateBtn.style.boxShadow = "0 2px 14px #c6f7cc3a";
        }
        validateBtn.onmouseout = function() {
            validateBtn.style.background = "linear-gradient(90deg, #c1e5c1 80%, #ecf8ea 100%)";
            validateBtn.style.boxShadow = "0 2px 9px #badcbd31";
        }
        validateBtn.onclick = function() {
            console.log("Validate actionDict", actionDict);
        };

        // Cancel button
        const cancelBtn = document.createElement('button');
        cancelBtn.type = "button";
        cancelBtn.innerHTML = "<span style='font-size:1.13em;margin-right:0.45em;'>‚úñÔ∏è</span>Cancel";
        cancelBtn.style.background = "linear-gradient(90deg, #fae6e6 80%, #fff5f7 100%)";
        cancelBtn.style.color = "#a02d2d";
        cancelBtn.style.fontWeight = "600";
        cancelBtn.style.padding = "0.58em 1.32em";
        cancelBtn.style.border = "none";
        cancelBtn.style.borderRadius = "0.9em";
        cancelBtn.style.fontSize = "1em";
        cancelBtn.style.cursor = "pointer";
        cancelBtn.style.boxShadow = "0 2px 9px #f8b3b331";
        cancelBtn.style.transition = "background 0.13s, color 0.13s, box-shadow 0.14s";
        cancelBtn.onmouseover = function() {
            cancelBtn.style.background = "linear-gradient(90deg,#fed8d8 80%,#ffe7f0 100%)";
            cancelBtn.style.boxShadow = "0 2px 14px #f6c7c74a";
        }
        cancelBtn.onmouseout = function() {
            cancelBtn.style.background = "linear-gradient(90deg, #fae6e6 80%, #fff5f7 100%)";
            cancelBtn.style.boxShadow = "0 2px 9px #f8b3b331";
        }
        cancelBtn.onclick = function() {
            console.log("Cancel actionDict", actionDict);
        };

        btnRow.appendChild(validateBtn);
        btnRow.appendChild(cancelBtn);
        dividerWithButton.appendChild(btnRow);
        cart.appendChild(dividerWithButton);

        return cart;
    }

    function simulateBotReply(userText) {
        setTimeout(function() {
            let reply;
            const lc = userText.trim().toLowerCase();
            if(!lc) reply = "I'm here!";
            else if(lc.includes('hello') || lc.includes('hi')) reply = "Hello! What can I do for you?";
            else if(lc.includes('weather')) reply = "I'm not connected to live data, but it looks like a great day to code!";
            else if(lc.includes('name')) reply = "I'm your AI Assistant, here to help.";
            else if(lc.match(/(\bwho are you\b|\bwhat are you\b)/)) reply = "I'm an AI chatbot created to assist you.";
            else reply = "‚ú® Let me look into that for you... (This is a demo ‚Äî replace me with your own model or API!)";
            appendMessage(reply, "bot");
        }, 550 + Math.random()*500);
    }

    // Autosize textarea
    function autoGrowTextarea(el) {
        el.style.height = "auto";
        // Use current computed max-height, obeying no vertical scroll
        const maxHeight = parseInt(window.getComputedStyle(el).maxHeight, 10) || 9999;
        el.style.overflowY = "hidden";
        el.style.height = (el.scrollHeight > maxHeight ? maxHeight : el.scrollHeight) + "px";
    }
    chatInput.addEventListener('input', function() {
        autoGrowTextarea(chatInput);
    });
    // Initialize to right size if autofilled or template
    window.addEventListener('DOMContentLoaded', function() {
        autoGrowTextarea(chatInput);
    });

    chatForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        if (chatBusy) return; // Prevent new submit while busy
        chatBusy = true; // set busy
        sendBtn.disabled = true; // disable send button
        chatInput.readOnly = true; // make input readonly to avoid typing more

        const value = chatInput.value.trim();
        if (!value) {
            chatBusy = false;
            sendBtn.disabled = false;
            chatInput.readOnly = false;
            return;
        }
        // Log the content of the message to the console as requested
        console.log("User message:", value);
        appendMessage(value, "user");

        // Show the typing indicator *before* the fetch, and remove it on stream start
        showTypingIndicator();

        // Wait a small delay to show the typing indicator for realism, or begin fetch immediately.
        // Uncomment below for minimum time (optional UX):
        // await new Promise(resolve => setTimeout(resolve, 350));

        const response = await fetch(`/response?prompt=${encodeURIComponent(value)}`);
        chatInput.textContent = "" ; 
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        bubble = appendStream();
        console.log("the bubble object ");
        console.log(bubble);
        let output = "";
        let pre = document.createElement('pre');
        // Style the pre to wrap long lines and pre-wrap whitespace
        pre.style.whiteSpace = "pre-wrap";
        pre.style.wordBreak = "break-word";
        bubble.appendChild(pre);
        pre.textContent = "Thinking ...." ; 
        let thinking = false ; 
        if (data["agent_type"] == "tool_calling") {
            let tools_details = ""  ; 
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                const chunk = decoder.decode(value,{stream : true}) ; 
                
                output += chunk ; 
                if (output.includes("<think>")) {
                    if (!thinking) {
                        pre.textContent = "" ; 
                        thinking = true ; 
                    }
                    if (!chunk.includes(">") && !output.includes("</") )
                        pre.textContent += chunk ; 
                    else if (output.includes("</think>")) 
                    {
                        if (!chunk.inlcudes) {
                            tools_details += chunk ;                            
                        }
                    }
                    
                }
            
            }
            console.log("full tools details ") ; 
            console.log(tools_details) ; 
            let action_dict = parseActionString(tools_details) ; 
            console.log("action dict") 
            console.log(action_dict)

            // ---- üéØ Insert AI "cart" with tool name/inputs here ----
            const toolCartElem = createToolCart(action_dict);
            // Remove the "Thinking..." pre (if any) before showing cart
            if (pre.parentNode) {
                pre.parentNode.removeChild(pre);
            }
            bubble.appendChild(toolCartElem);

        //     fetch ("http://127.0.0.1:8080/run_tool" , {
        //     method : 'POST' , 
        //     headers : {
        //         'Content-Type': 'application/json' , 
        //     }, 
        //     body : JSON.stringify(action_dict)
        // }).then(response => response.json())
        //  .then(result => console.log(result))
        //  .catch(error => console.error('Error:', error));


        } else if (data["agent_type"] == "chat_bot")  {

            while (true) {
                const { done, value } = await reader.read();
            if (done) break;
            
            const chunk = decoder.decode(value, { stream: true });

            if (chunk.includes("[DONE]")) break;

            output += chunk;
            pre.textContent = output;
            
            console.log(output);
        }
     }

        chatInput.value = "";
        autoGrowTextarea(chatInput); // Reset textarea height after send
        // simulateBotReply(value);
        //     fetch (`/response?prompt=${encodeURIComponent(value)}`, {
        //     method : 'GET' , 
        //     headers : {
        //         'Content-Type': 'application/json' , 
        //     },
        // }).then(response => response.json())
        //  .then(result => console.log(result))
        //  .catch(error => console.error('Error:', error));

        // Restore button and input state
        chatBusy = false;
        sendBtn.disabled = false;
        chatInput.readOnly = false;
    });


    chatInput.addEventListener('keydown', function(e) {
        if (e.key === "Enter" && !e.shiftKey) {
            // Prevent ENTER from sending if busy
            if (sendBtn.disabled) {
                e.preventDefault();
                return;
            }
            e.preventDefault();
            sendBtn.click();
        }
    });

    // Sidebar navigation active state (matches style)
    document.querySelectorAll('.sidebar-nav-link').forEach(link => {
        link.addEventListener('click', function(e) {
            document.querySelectorAll('.sidebar-nav-link').forEach(x => x.classList.remove('active'));
            link.classList.add('active');
            e.preventDefault();
            let titleNode = Array.from(link.childNodes).find(node =>
                node.nodeType === 3 && node.textContent.trim()
            );
            let sectionTitle = titleNode ? titleNode.textContent.trim() : link.textContent.trim();
            console.log("zebi zebi")
            console.log(sectionTitle);
            if (sectionTitle == "Tests") {
                window.location.href = "/tests" ; 
            } else if (sectionTitle == "Agent Configuration") {
                window.location.href = "/agent_config"
            }
        })
    });

    // --- View switching logic (chat/code/logger) ---
    const btnChat = document.getElementById('btn-chat');
    const btnCode = document.getElementById('btn-code');
    const btnLogger = document.getElementById('btn-logger');

    function showChatView() {
        chatWindow.style.display = '';
        chatFooter.style.display = '';
        codeSection.style.display = 'none';
        loggerSection.style.display = 'none';
    }
    function showCodeView() {
        chatWindow.style.display = 'none';
        chatFooter.style.display = 'none';
        codeSection.style.display = 'flex';
        loggerSection.style.display = 'none';

        // Monaco loader
        if (!monacoInitialized) {
            monacoInitialized = true;
            window.require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs' } });
            window.require(['vs/editor/editor.main'], function() {
                monaco.editor.defineTheme('assistant-light', {
                    base: 'vs',
                    inherit: true,
                    rules: [
                        { token: 'comment', foreground: '90a4ae' },
                        { token: 'keyword', foreground: '21528f', fontStyle: 'bold' },
                        { token: 'string', foreground: '388e3c' },
                        { token: 'number', foreground: '00838f' },
                        { token: 'identifier', foreground: '234881' }
                    ],
                    colors: {
                        "editor.background": "#f7f9fb",
                        "editor.foreground": "#2c455f",
                        "editor.lineHighlightBackground": "#e9effc",
                        "editor.lineHighlightBorder": "#e9effc",
                        "editorCursor.foreground": "#3DA8F5",
                        "editorLineNumber.foreground": "#b3bdcf",
                        "editorIndentGuide.background": "#eaeaea",
                        "editorIndentGuide.activeBackground": "#bfdffa",
                        "editor.selectionBackground": "#b8e5fa44",
                        "editorWidget.background": "#f9fbff",
                        "editorWidget.border": "#cbe6fa",
                        "editorGutter.background": "#f7f9fb",
                        "editorBracketMatch.background": "#dbefff",
                        "editorBracketMatch.border": "#bde4fa",
                    }
                });
                const initialCode = [
                    '// Welcome to the Monaco Editor!',
                    'function greet(name) {',
                    '    return `Hello, ${name}!`;',
                    '}',
                    '',
                    'console.log(greet("world"));'
                ].join('\n');
                monacoEditor = monaco.editor.create(
                    document.getElementById('monaco-editor-container'), {
                        value: initialCode,
                        language: 'javascript',
                        automaticLayout: true,
                        theme: 'assistant-light',
                        minimap: { enabled: false },
                        fontSize: 15,
                        fontFamily: "Fira Mono, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace",
                        scrollbar: { verticalScrollbarSize: 7, horizontalScrollbarSize: 7 }
                    }
                );
                monacoLoaderQueue.forEach(cb => cb());
                monacoLoaderQueue = [];
            });
        } else if (monacoEditor) {
            setTimeout(function() {
                monacoEditor.layout();
                monacoEditor.focus();
            }, 100);
        }
    }

    function showLoggerView() {
        chatWindow.style.display = 'none';
        codeSection.style.display = 'none';
        chatFooter.style.display = 'none';
        loggerSection.style.display = 'flex';
    }

    // Action bar button logic with view switch
    document.querySelectorAll('.action-bar-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.action-bar-btn').forEach(x => x.classList.remove('active'));
            btn.classList.add('active');
            if (btn === btnChat) {
                showChatView();
            } else if (btn === btnCode) {
                showCodeView();
            } else if (btn === btnLogger) {
                showLoggerView();
            }
        });
    });

    // Collapsible behavior for log-collapsed-info
    function setupLoggerCollapsible() {
        const collapsedInfo = document.getElementById('log-collapsed-info-1');
        if (!collapsedInfo) return;
        const header = collapsedInfo.querySelector('.log-collapsed-header');
        collapsedInfo.classList.add('collapsed');
        function toggle() {
            if (collapsedInfo.classList.contains('collapsed')) {
                collapsedInfo.classList.remove('collapsed');
            } else {
                collapsedInfo.classList.add('collapsed');
            }
        }
        header.addEventListener('click', toggle);
        header.addEventListener('keydown', function(e){
            if (e.key === 'Enter' || e.key === ' ') {
                toggle();
                e.preventDefault();
            }
        });
    }

    // Make "Live Chat" sidebar link active on load
    document.addEventListener('DOMContentLoaded', function() {
        var links = document.querySelectorAll('.sidebar-nav-link');
        links.forEach(x => x.classList.remove('active'));
        var liveChat = document.querySelector('.sidebar-nav-link[data-section="settings"]');
        if (liveChat) liveChat.classList.add('active');
        setupLoggerCollapsible();
    });

    // If script loads after DOM ready
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
        setTimeout(function() {
            var links = document.querySelectorAll('.sidebar-nav-link');
            links.forEach(x => x.classList.remove('active'));
            var liveChat = document.querySelector('.sidebar-nav-link[data-section="settings"]');
            if (liveChat) liveChat.classList.add('active');
            setupLoggerCollapsible();
        }, 0);
    }

    // Load Chat view by default
    showChatView();

})();
</script>

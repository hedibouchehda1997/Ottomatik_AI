<!DOCTYPE html> 
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Set</title>
    <link rel="stylesheet" href="/static/table.css">
    <style>
      .table-title-controls {
        display: flex;
        align-items: center;
        gap: 0.65em;
        margin-left: auto;
      }
      .table-title {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        padding-bottom: 0.35em;
        box-sizing: border-box;
      }
      /* ADDED: Give each table stack a gap below */
      .table-stack-single {
        margin-bottom: 2.4em;
      }
      .add-row-modal {
        display: flex;
        flex-direction: column;
        align-items: stretch;
        position: fixed;
        z-index: 5000;
        top: 38vh;
        left: 0;
        right: 0;
        margin-left: auto;
        margin-right: auto;
        max-width: 400px;
        box-sizing: border-box;
        background: #fafcfe;
        border: 1.15px solid #b4e3fc;
        border-radius: 1.1em;
        box-shadow: 0 6px 23px #bae1fc38, 0 2.5px 7px #bae1fc16;
        padding: 2em 2em 1.6em 2em;
        color: #23456f;
        font-size: 1.05em;
        min-width: 250px;
        outline: none;
      }
      .add-row-backdrop {
        position: fixed;
        top:0; left:0; right:0; bottom:0;
        background: rgba(104,175,226,0.10);
        z-index: 4000;
      }
      .add-row-modal-label {
        font-weight: 600;
        color: #23548f;
        margin-bottom: 0.35em;
        font-size: 1.13em;
      }
      .add-row-modal-input {
        padding: 0.7em 1em;
        border-radius: 0.7em;
        border: 1.1px solid #bae1fc;
        background: #f8fbfd;
        color: #315593;
        font-weight: 500;
        font-size: 1.12em;
        width: 100%;
        box-sizing: border-box;
        margin-bottom: 1.1em;
      }
      .add-row-modal-btns {
        display: flex;
        gap: 1em;
        justify-content: flex-end;
        margin-top: 0.1em;
      }
      .add-row-modal-btn {
        padding: 0.48em 1.2em;
        font-size: 1.02em;
        border-radius: 0.7em;
        border: none;
        font-weight: 600;
        cursor: pointer;
        background: linear-gradient(90deg, #2798ef 60%, #6ebbe8 100%);
        color: #fff;
        transition: background 0.12s;
      }
      .add-row-modal-btn.cancel {
        background: linear-gradient(90deg, #ffb9b9 60%, #ffc8e2 100%);
        color: #23456f;
      }
      @media (max-width: 600px) {
        .add-row-modal {
          max-width: 94vw;
          padding: 1em 0.6em 1.1em 0.6em;
        }
      }
    </style>
</head>

<div class="app-root-flex">
  <nav class="sidebar-modern" id="app-sidebar">
    <div class="sidebar-brand">
      <span style="font-size:1.45em;filter:drop-shadow(0 2px 8px #94bdf854);">ü§ñ</span>
      <span>Assistant Suite</span>
    </div>
    <div class="sidebar-nav">
      <a href="#" class="sidebar-nav-link active" data-section="tests">
        <span class="sidebar-emoji">üß™</span>
        Tests
      </a>
      <a href="#" class="sidebar-nav-link" data-section="agent">
        <span class="sidebar-emoji">‚öôÔ∏è</span>
        Agent Configuration
      </a>
      <a href="#" class="sidebar-nav-link" data-section="chat">
        <span class="sidebar-emoji">üí¨</span>
        Live Chat
      </a>
    </div>
  </nav>
  <div class="table-layout-flex show-table" id="table-layout-flex" style="flex: 1 1 0; min-width: 0;">
    <!-- Modern Agent Config form (hidden by default) -->
    <div class="agent-config-container" id="agent-config-container">
      <!-- Agent configuration form removed -->
    </div>
    <!-- Modern Table Display (visible by default) -->
    <div class="interactive-table-container" id="interactive-table-container">
      <!-- Button Container: Centered horizontally with both buttons -->
      <div class="btn-container-centered" id="add-test-set-btn-container">
        <button class="add-test-set-btn" id="add-test-set-btn" type="button">Add Test Set</button>
        <label class="upload-test-set-label" id="upload-test-set-label">
          Upload Test Set
          <input type="file" id="upload-test-set-input" multiple>
        </label>
      </div>
      <!-- Add Test Set form display below button, hidden by default -->
      <div class="add-test-set-form-wrap" id="add-test-set-form-wrap">
        <form class="add-test-set-form" id="add-test-set-form" autocomplete="off">
          <!-- Test Set Name label and input -->
          <label class="add-test-set-form-label-main" for="add-ts-name">Test Set Name</label>
          <input
              type="text"
              id="add-ts-name"
              name="test_set_name"
              placeholder="Enter test set name"
              style="margin-bottom:1.05em; font-size: 1.12em; padding: 0.7em 1em; border-radius:0.7em; border:1.1px solid #bae1fc; background:#f8fbfd; color:#315593; font-weight: 500; width: 100%; box-sizing: border-box;"
              autocomplete="off"
          >
          <label class="add-test-set-form-label-main" for="add-ts-columns">Columns</label>
          <div class="add-test-set-form-checkbox-group" id="add-ts-columns">
            <label class="add-test-set-form-checkbox-label">
              <input type="checkbox" name="columns" value="User Query" checked> User Query
            </label>
            <label class="add-test-set-form-checkbox-label">
              <input type="checkbox" name="columns" value="Ground Truth" checked> Ground Truth
            </label>
          </div>
          <!-- Insert Metrics label and combo here -->
          <label class="add-test-set-form-metrics-label" for="add-test-set-form-metrics-select">Metrics</label>
          <select class="add-test-set-form-metrics-select" id="add-test-set-form-metrics-select" name="metrics">
            <option value="" selected disabled></option>
            <option value="ai_as_judge">AI as judge</option>
          </select>
          <!-- AI as judge custom fields will appear here -->
          <div id="ai-as-judge-fields-container" style="display: none;"></div>
          <div class="add-test-set-form-btns">
            <button type="button" class="build-btn" id="add-test-set-build-btn">Build</button>
            <button type="button" class="cancel-btn" id="add-test-set-cancel-btn">Cancel</button>
          </div>
        </form>
      </div>
      <!-- Table wrapper area for stacking tables -->
      <div id="multi-table-stack"></div>
    </div>
    <div class="right-pane-detail" id="right-pane-detail"></div>
  </div>
</div>
<script>
(function(){


      document.querySelectorAll('.sidebar-nav-link').forEach(link => {
        link.addEventListener('click', function(e) {
            document.querySelectorAll('.sidebar-nav-link').forEach(x => x.classList.remove('active'));
            link.classList.add('active');
            e.preventDefault();
            let titleNode = Array.from(link.childNodes).find(node =>
                node.nodeType === 3 && node.textContent.trim()
            );
            let sectionTitle = titleNode ? titleNode.textContent.trim() : link.textContent.trim();
            console.log("zebi zebi")
            console.log(sectionTitle);
            if (sectionTitle == "Tests") {
                window.location.href = "/tests" ; 
            } else if (sectionTitle == "Agent Configuration") {
                window.location.href = "/agent_config"
            }
        })
    });
    // DATA MODEL: store multiple tables!
    let TABLES = [
      {
        name: "Test soviet",
        columns: [
            { key: "User Query", label: "User Query", className: "user-query-cell", widthWeight: 1 },
            { key: "Ground Truth", label: "Ground Truth", widthWeight: 2 },
            { key: "Generated Output", label: "Generated Output", widthWeight: 1 },
            { key: "Relevance", label: "Relevance", widthWeight: 1 }
        ],
        rows: [
            {
                "User Query": "What is the capital of France?",
                "Ground Truth": "Paris",
                "Generated Output": "Paris",
                "Relevance": {label: "Very Relevant", badge: "relevant", emoji: "‚úÖ"}
            },
            {
                "User Query": "Summarize the theory of evolution.",
                "Ground Truth": "Evolution describes the process by which species change over time through natural selection.",
                "Generated Output": "Species adapt and change gradually over generations due to natural selection.",
                "Relevance": {label: "Very Relevant", badge: "relevant", emoji: "‚úÖ"}
            },
            {
                "User Query": "Translate \"Hello\" to Spanish.",
                "Ground Truth": "Hola",
                "Generated Output": "Hola",
                "Relevance": {label: "Very Relevant", badge: "relevant", emoji: "‚úÖ"}
            },
            {
                "User Query": "Who wrote '1984'?",
                "Ground Truth": "George Orwell",
                "Generated Output": "George Orwell",
                "Relevance": {label: "Very Relevant", badge: "relevant", emoji: "‚úÖ"}
            },
            {
                "User Query": "Explain Python list comprehensions.",
                "Ground Truth": "List comprehensions provide a concise way to create lists using a single line of code.",
                "Generated Output": "A Python list comprehension is a compact way to create lists from iterables.",
                "Relevance": {label: "Quite Relevant", badge: "quite", emoji: "‚úÖ"}
            }
        ]
      }
    ];

    // helpers
    function setColumnWidths(table, columns) {
        const allCols = [...columns, { key: "__run_btn__", label: "", widthWeight: 0.4 }];
        const totalWeight = allCols.reduce((s, col) => s + (col.widthWeight || 1), 0);
        let colgroup = table.querySelector('colgroup');
        if (colgroup) colgroup.remove();
        colgroup = document.createElement('colgroup');
        allCols.forEach((col, idx) => {
            const colEl = document.createElement('col');
            colEl.className = 'col-' + (idx+1);
            const perc = ((col.widthWeight||1) / totalWeight * 100).toFixed(3);
            colEl.style.width = perc+'%';
            colgroup.appendChild(colEl);
        });
        table.insertBefore(colgroup, table.firstChild);
    }

    // Always only clear all table DOM nodes in the multi-table-stack container
    function clearAllTablesFromStack() {
        let tables_container = document.getElementById("multi-table-stack");
        if (tables_container) tables_container.innerHTML = '';
    }

    // Render ALL tables in TABLES array
    function renderAllTables() {
        clearAllTablesFromStack();
        let stack = document.getElementById("multi-table-stack");
        // Sort tables for consistent order (most recent last)
        TABLES.forEach(function(tableObj, i) {
            renderTable(tableObj.columns, tableObj.rows, tableObj.name, stack, i);
        });
    }

    // Render one table WITHIN the stack
    function renderTable(columns, dataRows, table_name, container, tableIndex) {
        container = container || document.getElementById("multi-table-stack");

        // Table Title
        const tableTitle = document.createElement("div");
        tableTitle.className = "table-title";

        // Title text/emoji
        const innerSpan = document.createElement("span");
        innerSpan.style.display = "flex";
        innerSpan.style.alignItems = "center";
        innerSpan.style.gap = "0.45em";

        const emojiSpan = document.createElement("span");
        emojiSpan.className = "table-title-emoji";
        emojiSpan.textContent = "üìù";
        innerSpan.appendChild(emojiSpan);
        innerSpan.appendChild(document.createTextNode(table_name));

        // --- Button controls ---
        const controlsDiv = document.createElement("div");
        controlsDiv.className = "table-title-controls";

        // Run button
        const button = document.createElement("button");
        button.className = "run-test-btn";
        button.type = "button";
        button.textContent = "Run";
        button.onclick = function() {
            // Print {table_name: ..., tests: [...] }
            const tableObj = TABLES[tableIndex];
            const result = tableObj.rows.map(function(row, idx) {
                let obj = { user_query: row["User Query"], num_row: idx };
                if ('Ground Truth' in row) {
                    obj.ground_truth = row["Ground Truth"];
                }
                return obj;
            });
            const output = {
                table_name: tableObj.name,
                tests: result
            };
            //add the fetch here 
            fetch ("http://localhost:3030/run_tests" , {
                    method : 'POST' , 
                    headers : {
                        'Content-Type': 'application/json' , 
                    }, 
                    body : JSON.stringify(output)
                }).then(response => response.json())
                .then(result => console.log(result))
                .catch(error => console.error('Error:', error));

            console.log(output);
        };

        // Add Row button
        const addRowButton = document.createElement("button");
        addRowButton.type = "button";
        addRowButton.className = "run-test-btn add-row-btn";
        addRowButton.style.marginLeft = "0";
        addRowButton.textContent = "Add Row";
        addRowButton.onclick = function() {
            if (document.getElementById("add-row-modal")) return;
            showAddRowModal(tableIndex);
        };

        controlsDiv.appendChild(button);
        controlsDiv.appendChild(addRowButton);
        tableTitle.appendChild(innerSpan);
        tableTitle.appendChild(controlsDiv);

        // Main table
        let table = document.createElement("table");
        table.className = "interactive-table";
        table.cellSpacing = "0";
        let thead = document.createElement("thead");
        let tbody = document.createElement("tbody");
        table.appendChild(thead);
        table.appendChild(tbody);

        setColumnWidths(table, columns);

        // Table header
        thead.innerHTML = '';
        const trHead = document.createElement('tr');
        columns.forEach((col, idx) => {
            const th = document.createElement('th');
            th.textContent = col.label;
            th.classList.add('col-' + (idx+1));
            trHead.appendChild(th);
        });
        // Run column th
        const thRun = document.createElement('th');
        thRun.textContent = 'Run';
        thRun.classList.add('col-' + (columns.length+1));
        trHead.appendChild(thRun);
        thead.appendChild(trHead);

        // Table body
        tbody.innerHTML = '';
        dataRows.forEach((row, rowIdx) => {
            const tr = document.createElement('tr');
            columns.forEach((col, idx) => {
                const td = document.createElement('td');
                td.classList.add('col-' + (idx+1));
                if (col.key === "User Query") {
                    td.classList.add('user-query-cell');
                }
                // For each cell in this row: Show the cell value, or blank if missing/null/undefined.
                if (col.key === "Relevance" && row["Relevance"]) {
                    const span = document.createElement('span');
                    span.className = `rel-badge ${row.Relevance.badge}`;
                    const checkEmoji = document.createElement('span');
                    checkEmoji.className = 'check-emoji';
                    checkEmoji.textContent = row.Relevance.emoji;
                    span.appendChild(checkEmoji);
                    span.appendChild(document.createTextNode(' ' + row.Relevance.label));
                    td.appendChild(span);
                } else {
                    td.textContent = row[col.key] != null ? row[col.key] : '';
                }
                tr.appendChild(td);
            });
            // Row Run button
            const tdRun = document.createElement('td');
            tdRun.classList.add('col-' + (columns.length+1));
            tdRun.style.textAlign = "center";
            tdRun.style.verticalAlign = "middle";
            tdRun.style.cursor = "default";
            const btn = document.createElement('button');
            btn.type = "button";
            btn.className = "row-run-btn";
            btn.setAttribute('aria-label', 'Run this test');
            btn.innerHTML = 'Run';
            btn.onclick = function(e){
                e.stopPropagation();
                // Populate the dictionary as requested: user_query, row_num, (optionally) ground_truth, table_name
                let test_2_run = {
                  user_query: row["User Query"],
                  row_num: rowIdx,
                  table_name: table_name
                };
                if ("Ground Truth" in row && row["Ground Truth"] !== undefined) {
                  test_2_run.ground_truth = row["Ground Truth"];
                }
                fetch ("http://localhost:3030/run_tests" , {
                    method : 'POST' , 
                    headers : {
                        'Content-Type': 'application/json' , 
                    }, 
                    body : JSON.stringify({
                        "tests" : [test_2_run],
                    })
                }).then(response => response.json())
                .then(result => console.log(result))
                .catch(error => console.error('Error:', error));
                console.log(test_2_run);
            };
            tdRun.appendChild(btn);
            tr.appendChild(tdRun);

            tbody.appendChild(tr);
        });

        // Compose
        let wrapper = document.createElement('div');
        wrapper.className = "table-stack-single";
        wrapper.appendChild(tableTitle);
        wrapper.appendChild(table);

        // Actually render into the stack
        container.appendChild(wrapper);
    }

    // Show custom "Add Row" modal (for specified table!)
    function showAddRowModal(tableIndex) {
        // Identify the target table and its columns
        const tableObj = TABLES[tableIndex];
        const tableColumns = tableObj.columns.map(col => col.key);

        // Modal logic -- dynamic fields
        const backdropDiv = document.createElement('div');
        backdropDiv.className = 'add-row-backdrop';
        backdropDiv.onclick = function(){ closeAddRowModal(); };
        document.body.appendChild(backdropDiv);

        const modalDiv = document.createElement('div');
        modalDiv.className = 'add-row-modal';
        modalDiv.id = 'add-row-modal';
        modalDiv.tabIndex = -1;

        modalDiv.onkeydown = function(e) {
          if (e.key === "Escape") closeAddRowModal();
        };

        // We'll dynamically add only "User Query" and "Ground Truth" if present
        let userQinput = null, gtInput = null;
        // Button controls
        const btnWrap = document.createElement('div');
        btnWrap.className = 'add-row-modal-btns';

        // Cancel
        const cancelBtn = document.createElement('button');
        cancelBtn.type = 'button';
        cancelBtn.className = 'add-row-modal-btn cancel';
        cancelBtn.textContent = 'Cancel';
        cancelBtn.onclick = closeAddRowModal;

        // Add button
        const addBtn = document.createElement('button');
        addBtn.type = 'button';
        addBtn.className = 'add-row-modal-btn';
        addBtn.textContent = 'Add';

        // Only include the User Query input if present
        if (tableColumns.includes("User Query")) {
          const userQlabel = document.createElement('label');
          userQlabel.className = 'add-row-modal-label';
          userQlabel.htmlFor = 'add-row-user-query';
          userQlabel.textContent = 'User Query';
          userQinput = document.createElement('input');
          userQinput.className = 'add-row-modal-input';
          userQinput.type = 'text';
          userQinput.id = 'add-row-user-query';
          userQinput.name = 'user_query';
          userQinput.placeholder = 'Enter user query';
          userQinput.required = true;
          modalDiv.appendChild(userQlabel);
          modalDiv.appendChild(userQinput);
        }

        // Only include the Ground Truth input if present
        if (tableColumns.includes("Ground Truth")) {
          const gtLabel = document.createElement('label');
          gtLabel.className = 'add-row-modal-label';
          gtLabel.htmlFor = 'add-row-ground-truth';
          gtLabel.textContent = 'Ground Truth';
          gtInput = document.createElement('input');
          gtInput.className = 'add-row-modal-input';
          gtInput.type = 'text';
          gtInput.id = 'add-row-ground-truth';
          gtInput.name = 'ground_truth';
          gtInput.placeholder = 'Enter ground truth';
          gtInput.required = true;
          modalDiv.appendChild(gtLabel);
          modalDiv.appendChild(gtInput);
        }

        // Add button - logic changed: Only require whichever fields are present
        addBtn.onclick = function() {
            if ((userQinput && !userQinput.value.trim()) ||
                (gtInput && !gtInput.value.trim())) {
                addBtn.textContent = "Fill all fields";
                addBtn.style.background = "linear-gradient(90deg,#ffbbaa 65%,#ff7474 100%)";
                setTimeout(()=>{
                  addBtn.textContent = "Add";
                  addBtn.style.background = "";
                }, 900);
                return;
            }
            let newRow = {};
            // Assign values ONLY for the inputs that were shown
            if (userQinput) newRow["User Query"] = userQinput.value.trim();
            if (gtInput)    newRow["Ground Truth"] = gtInput.value.trim();
            // All other slots (including 'Generated Output', metrics, etc) are undefined/empty
            tableObj.rows.push(newRow);
            closeAddRowModal();
            renderAllTables();
        };

        btnWrap.appendChild(cancelBtn);
        btnWrap.appendChild(addBtn);

        modalDiv.appendChild(btnWrap);

        document.body.appendChild(modalDiv);
        setTimeout(()=>{ 
            if (userQinput) userQinput.focus();
            else if (gtInput) gtInput.focus();
        }, 30);

        document.body.style.overflow = "hidden";
    }

    function closeAddRowModal() {
        let m = document.getElementById('add-row-modal');
        if (m) m.remove();
        let b = document.querySelector('.add-row-backdrop');
        if (b) b.remove();
        document.body.style.overflow = "";
    }

    // Initial State: show all tables
    renderAllTables();

    // --- Add Test Set Button logic ---
    function resetAddTestSetFormToInitial() {
        var f = document.getElementById('add-test-set-form');
        if (f) {
            f.reset();
        }
        var userQCb = document.querySelector('#add-ts-columns input[type="checkbox"][value="User Query"]');
        var gtCb = document.querySelector('#add-ts-columns input[type="checkbox"][value="Ground Truth"]');
        if (userQCb) userQCb.checked = true;
        if (gtCb) gtCb.checked = true;
        var metricsSel = document.getElementById("add-test-set-form-metrics-select");
        if (metricsSel) metricsSel.selectedIndex = 0;
        var aiFields = document.getElementById('ai-as-judge-fields-container');
        if (aiFields) aiFields.innerHTML = '';
        if (aiFields) aiFields.style.display = 'none';
    }

    window.AddTestSet = function() {
        resetAddTestSetFormToInitial();
        var formWrap = document.getElementById('add-test-set-form-wrap');
        if (!formWrap.classList.contains('active')) {
            formWrap.classList.add('active');
        }
    };

    var addTestSetBtn = document.getElementById('add-test-set-btn');
    if (addTestSetBtn) {
        addTestSetBtn.onclick = function() {
            window.AddTestSet();
        }
    }

    var addTestSetCancelBtn = document.getElementById('add-test-set-cancel-btn');
    if (addTestSetCancelBtn) {
        addTestSetCancelBtn.onclick = function() {
            var formWrap = document.getElementById('add-test-set-form-wrap');
            formWrap.classList.remove('active');
            const aiFields = document.getElementById('ai-as-judge-fields-container');
            if (aiFields) aiFields.innerHTML = '';
            if (aiFields) aiFields.style.display = 'none';
            resetAddTestSetFormToInitial();
        }
    }
    // Add Test Set Build button
    var addTestSetBuildBtn = document.getElementById('add-test-set-build-btn');
    if (addTestSetBuildBtn) {
        addTestSetBuildBtn.onclick = function() {
            var colInputs = document.querySelectorAll('#add-ts-columns input[type="checkbox"]:checked');
            var cols = [];
            colInputs.forEach(function(input){ cols.push(input.value); });
            // --- BEGIN PATCH: Use checked columns, then always insert 'Generated Output', then metric names ---
            let buildColumns = [];

            // Add each checked column as a column (keep order)
            cols.forEach(function(col) {
                if (col === "User Query") {
                    buildColumns.push({ key: "User Query", label: "User Query", className: "user-query-cell", widthWeight: 1 });
                } else if (col === "Ground Truth") {
                    buildColumns.push({ key: "Ground Truth", label: "Ground Truth", widthWeight: 2 });
                } else {
                    buildColumns.push({ key: col, label: col, widthWeight: 1 });
                }
            });

            // Now always add Generated Output column after checkboxes, before metrics
            buildColumns.push({ key: "Generated Output", label: "Generated Output", widthWeight: 1 });

            // Get AI judge metric names from display list, and add them as columns
            var aiJudgeLists = document.querySelectorAll('.ai-judge-display-list');
            let ai_oj = [];
            let metricNames = []; // For metrics columns

            if (aiJudgeLists.length) {
                aiJudgeLists.forEach(function(displayList){
                    var judges = displayList.querySelectorAll('.ai-judge-collapsible-toggle');
                    judges.forEach(function(judgeBtn){
                        var nameSpan = judgeBtn.querySelector('span:last-child');
                        var name = "";
                        if (nameSpan) {
                            var inHtml = nameSpan.innerHTML.match(/<span[^>]*>(.*?)<\/span>/);
                            name = inHtml ? inHtml[1].trim() : nameSpan.textContent.replace(/^Name:\s*/i,'').trim();
                        }
                        var prompt = "";
                        var wrapper = judgeBtn.parentNode;
                        var promptDiv = wrapper.querySelector('.ai-judge-collapsible-content');
                        if (promptDiv) {
                            var pre = promptDiv.querySelector('pre');
                            if (pre) prompt = pre.textContent.trim();
                        }
                        ai_oj.push({name: name, prompt: prompt});
                        metricNames.push(name);
                    });
                });
            }

            // Add all metric names as columns if any
            metricNames.forEach(function(metricName){
                // use key/label=metricName
                buildColumns.push({ key: metricName, label: metricName, widthWeight: 1 });
            });

            var resultObj = {
                Cols: cols,
                metrics: {
                    AI_as_a_judge: ai_oj
                }
            };
            let test_set_name = document.getElementById("add-ts-name").value.trim();

            // Add the new table to our TABLES model, with empty rows.
            TABLES.push({
              name: test_set_name,
              columns: buildColumns,
              rows: []
            });

            renderAllTables();

            // Hide form and reset
            var formWrap = document.getElementById('add-test-set-form-wrap');
            formWrap.classList.remove('active');
            const aiFields = document.getElementById('ai-as-judge-fields-container');
            if (aiFields) aiFields.innerHTML = '';
            if (aiFields) aiFields.style.display = 'none';
            resetAddTestSetFormToInitial();
        }
    }

    // --- Upload Test Set Input logic ---
    window.UploadTestSet = function(files) {
        if (files && files.length > 0) {
            console.log('User selected files for upload:');
            for (let i = 0; i < files.length; i++) {
                console.log(`File ${i + 1}:`, files[i].name);
            }
        }
    };

    var uploadTestSetInput = document.getElementById('upload-test-set-input');
    if (uploadTestSetInput) {
        uploadTestSetInput.addEventListener('change', function(e) {
            window.UploadTestSet(uploadTestSetInput.files);
            uploadTestSetInput.value = '';
        });
    }

    // ----------- LOGIC FOR AI AS JUDGE FIELDS IN FORM ---------------
    var aiFieldsContainer = document.getElementById("ai-as-judge-fields-container");
    var metricsSelect = document.getElementById("add-test-set-form-metrics-select");

    function createAiJudgeFields() {
        if (!aiFieldsContainer) return;
        aiFieldsContainer.innerHTML = `
            <div class="add-ai-judge-fields" id="add-ai-judge-fields-main">
              <div>
                <label for="ai-judge-name">Name</label>
                <input type="text" id="ai-judge-name" name="ai_judge_name" placeholder="e.g. Custom Judge Name" autocomplete="off">
              </div>
              <div>
                <label for="ai-judge-prompt">Prompt</label>
                <textarea id="ai-judge-prompt" name="ai_judge_prompt" placeholder="Prompt for AI as judge..." rows="4"></textarea>
              </div>
              <button type="button" class="add-ai-judge-btn" id="add-ai-judge-btn">Add</button>
            </div>
        `;
        aiFieldsContainer.style.display = '';

        setTimeout(function() {
            var addBtn = document.getElementById("add-ai-judge-btn");
            if (addBtn) {
                addBtn.onclick = function(e) {
                    e.preventDefault();
                    var nameValue = document.getElementById("ai-judge-name").value.trim();
                    var promptValue = document.getElementById("ai-judge-prompt").value.trim();
                    if (!nameValue || !promptValue) {
                        addBtn.textContent = "Please provide Name & Prompt";
                        addBtn.style.background = "linear-gradient(90deg,#ffbbaa 65%,#ff7474 100%)";
                        setTimeout(function() {
                            addBtn.textContent = "Add";
                            addBtn.style.background = "";
                        }, 1100);
                        return;
                    }
                    addBtn.textContent = "Added!";
                    addBtn.style.background = "linear-gradient(90deg,#41d89d 70%,#9bf7a7 100%)";
                    console.log("AI Judge Name:", nameValue);
                    console.log("AI Judge Prompt:", promptValue);

                    var wrapperDiv = document.createElement("div");
                    wrapperDiv.className = "ai-judge-collapsible";
                    wrapperDiv.style.margin = "1em 0 0.4em 0";
                    wrapperDiv.style.borderRadius = "0.42em";
                    wrapperDiv.style.background = "#f5fafc";
                    wrapperDiv.style.boxShadow = "0 1.5px 9px #cbe5fb1f";
                    wrapperDiv.style.padding = "0";

                    var toggleBtn = document.createElement("button");
                    toggleBtn.type = "button";
                    toggleBtn.className = "ai-judge-collapsible-toggle";
                    toggleBtn.style.width = "100%";
                    toggleBtn.style.background = "none";
                    toggleBtn.style.border = "none";
                    toggleBtn.style.textAlign = "left";
                    toggleBtn.style.fontSize = "1.04em";
                    toggleBtn.style.fontWeight = "600";
                    toggleBtn.style.color = "#315699";
                    toggleBtn.style.cursor = "pointer";
                    toggleBtn.style.padding = "1em 0.9em";
                    toggleBtn.style.display = "flex";
                    toggleBtn.style.alignItems = "center";
                    var caret = document.createElement("span");
                    caret.className = "caret-collapsible-icon";
                    caret.textContent = "‚ñ∂";
                    caret.style.marginRight = "0.6em";
                    caret.style.transition = "transform 0.16s";
                    toggleBtn.appendChild(caret);

                    var nameLabel = document.createElement("span");
                    nameLabel.innerHTML = "<strong>Name:</strong> " +
                        "<span style='color:#315699; font-weight:600'>" + nameValue + "</span>";
                    toggleBtn.appendChild(nameLabel);

                    var collapsibleDiv = document.createElement("div");
                    collapsibleDiv.className = "ai-judge-collapsible-content";
                    collapsibleDiv.style.display = "none";
                    collapsibleDiv.style.padding = "0 0.9em 1.0em 2.7em";

                    collapsibleDiv.innerHTML = 
                        "<strong style='color:#24527b;'>Prompt:</strong><br>" +
                        "<pre style='background:none; display:block; color:#24527b; font-family:inherit; white-space:pre-wrap; margin:0;'>" + promptValue + "</pre>";

                    toggleBtn.onclick = function() {
                        var isOpen = collapsibleDiv.style.display === "block";
                        if (isOpen) {
                            collapsibleDiv.style.display = "none";
                            caret.style.transform = "";
                            caret.textContent = "‚ñ∂";
                        } else {
                            collapsibleDiv.style.display = "block";
                            caret.style.transform = "rotate(90deg)";
                            caret.textContent = "‚ñº";
                        }
                    };

                    wrapperDiv.appendChild(toggleBtn);
                    wrapperDiv.appendChild(collapsibleDiv);

                    var fieldsMain = document.getElementById("add-ai-judge-fields-main");
                    if (fieldsMain && fieldsMain.parentNode) {
                        var displayContainer = fieldsMain.parentNode.querySelector(".ai-judge-display-list");
                        if (!displayContainer) {
                            displayContainer = document.createElement("div");
                            displayContainer.className = "ai-judge-display-list";
                            displayContainer.style.marginTop = "1em";
                            fieldsMain.parentNode.insertBefore(displayContainer, fieldsMain.nextSibling);
                        }
                        displayContainer.appendChild(wrapperDiv);
                    }

                    setTimeout(function() {
                        addBtn.textContent = "Add";
                        addBtn.style.background = "";
                        document.getElementById("ai-judge-name").value = "";
                        document.getElementById("ai-judge-prompt").value = "";
                    }, 900);
                };
            }
        }, 8);
    }

    function hideAiJudgeFields() {
        if (!aiFieldsContainer) return;
        aiFieldsContainer.innerHTML = "";
        aiFieldsContainer.style.display = "none";
    }

    if (metricsSelect) {
        metricsSelect.addEventListener("change", function(e) {
            if (metricsSelect.value === "ai_as_judge") {
                createAiJudgeFields();
            } else {
                hideAiJudgeFields();
            }
        });
    }

    var addTestSetForm = document.getElementById('add-test-set-form');
    addTestSetForm && addTestSetForm.addEventListener('reset', function() {
        hideAiJudgeFields();
    });

    // -- End PATCH
})();
</script>
</html>